<!DOCTYPE html>
<html lang="zh">
<head>
<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<title>{{filename}}</title>
<style type="text/css">
html,body{
    padding:0;margin:0
}
</style>
<link rel="stylesheet" href="/static/public/md-editor/lib/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="/static/public/md-editor/lib/codemirror/addon/dialog/dialog.css">

{% comment %} <link rel="stylesheet" href="/static/public/md-editor/lib/codemirror/theme/midnight.css">
<link rel="stylesheet" href="/static/public/md-editor/lib/codemirror/theme/solarized.css"> {% endcomment %}

{% comment %} <link rel="stylesheet" href="/static/public/md-editor/lib/codemirror/theme/night.css"> {% endcomment %}

<script src="/static/public/md-editor/lib/codemirror/lib/codemirror.js"></script>
<script src="/static/public/md-editor/lib/codemirror/addon/dialog/dialog.js"></script>
<script src="/static/public/md-editor/lib/codemirror/addon/mode/loadmode.js"></script>
<script src="/static/public/md-editor/lib/codemirror/mode/meta.js"></script>

<script src="/static/public/md-editor/lib/codemirror/addon/search/searchcursor.js"></script>
<script src="/static/public/md-editor/lib/codemirror/addon/edit/matchbrackets.js"></script>
{% comment %} <script src="/static/public/md-editor/lib/codemirror/keymap/vim.js"></script> {% endcomment %}
<script src="/static/public/md-editor/jquery.min.js"></script>

</head>
<body>
<div id="text-view" style="width:100%;height:100%">
    <!-- Server-side output Markdown text -->
    <textarea name="content" style="width:100%;height:100%" id="content">{{content}}</textarea>

    <input type="hidden" id="id" value="{%if id%}{{id}}{%else%}0{%endif%}"/>
    <input type="hidden" id="filename" value="{{filename}}"/>
    {% csrf_token %}
</div>
<script type="text/javascript">
    file_type={
        'sh': 'shell',
        'php': 'php',
        'py': 'python',
        'js': 'javascript',
        'html': 'htmlmixed',
        'htm': 'htmlmixed',
        'conf': 'textile',
        'log': 'textile',
        'txt': 'textile',
        'sql': 'sql',
        'go': 'go',
        'json': 'javascript',
        'xml': 'xml',
        'yaml':'yaml',
        'yam': 'yaml',
    }
    a=$('#filename').val().split('.');
    jQuery.getScript("/static/public/md-editor/lib/codemirror/mode/"+file_type[a[a.length-1]]+'/'+file_type[a[a.length-1]]+'.js',function(){
        load_vim();
    })

    function load_vim(){
        var ext = file_type[a[a.length-1]];
        //console.log(ext)        
        var editor = CodeMirror.fromTextArea(document.getElementById("content"), {
            lineNumbers: true,
            mode: ext,
            keyMap: "default",
            matchBrackets: true,
            //theme:'solarized',
            //showCursorWhenSelecting: true,
            inputStyle: "contenteditable"
        });
        editor.setSize($(window).width(), $(window).height());
        // save
        CodeMirror.commands.save = function(){
            id=$('#id').val()
            csrf=$('input[name="csrfmiddlewaretoken"').val()
            content=editor.getValue();

            if (id<=0){
                return false;
            }

            $.ajax({
                url:'/admin/save/',
                type:'post',
                data:{
                    'id':id,
                    'csrfmiddlewaretoken':csrf,
                    'content':content
                },
                success:function(d){
                    alert(d.msg)
                },
                error:function(e){
                    alert(JSON.stringify(e))
                }
            });            
        };
        
    }
    
</script> 
</body>
</html>